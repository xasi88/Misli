<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <meta name="theme-color" content="#2a7fff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Мысли вокруг">
  <link rel="manifest" href="data:application/json,%7B%22name%22%3A%22%D0%9C%D1%8B%D1%81%D0%BB%D0%B8%20%D0%B2%D0%BE%D0%BA%D1%80%D1%83%D0%B3%22%2C%22short_name%22%3A%22%D0%9C%D1%8B%D1%81%D0%BB%D0%B8%22%2C%22description%22%3A%22%D0%90%D0%BD%D0%BE%D0%BD%D0%B8%D0%BC%D0%BD%D1%8B%D0%B5%20%D0%BC%D1%8B%D1%81%D0%BB%D0%B8%20%D0%B2%D0%BE%D0%BA%D1%80%D1%83%D0%B3%20%D0%B2%D0%B0%D1%81%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23f2f4f8%22%2C%22theme_color%22%3A%22%232a7fff%22%2C%22orientation%22%3A%22portrait%22%7D">
  <title>Мысли вокруг</title>
  <style>
    :root {
      --bg: #f2f4f8;
      --card: #ffffff;
      --text: #1f2a37;
      --muted: #6b7280;
      --blue1: #2a7fff;
      --blue2: #66a3ff;
      --green1: #10b981;
      --red1: #ef4444;
      --orange1: #f59e0b;
      --shadow1: 0 8px 20px rgba(16,24,40,0.10);
      --shadow2: 0 2px 8px rgba(16,24,40,0.10);
      --radius-lg: 18px;
      --radius-md: 14px;
      --radius-sm: 12px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 12px;
    }

    .phone-container {
      width: 100%;
      max-width: 420px;
      height: calc(100vh - 24px);
      height: calc(100dvh - 24px);
      max-height: 850px;
      background: var(--bg);
      border-radius: 32px;
      box-shadow: var(--shadow1);
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: linear-gradient(135deg, var(--blue1) 0%, var(--blue2) 100%);
      padding: 16px 20px 32px;
      position: relative;
      flex-shrink: 0;
      border-radius: 32px 32px 0 0;
    }

    .header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 20px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 100' preserveAspectRatio='none'%3E%3Cpath fill='%23f2f4f8' d='M0,0 C480,100 960,100 1440,0 L1440,100 L0,100 Z'/%3E%3C/svg%3E") no-repeat bottom;
      background-size: 100% 100%;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      z-index: 1;
    }

    .header-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 50%;
      transition: background 0.15s;
      position: relative;
    }

    .header-icon:active {
      background: rgba(255,255,255,0.2);
    }

    .header-icon svg {
      width: 24px;
      height: 24px;
      fill: white;
    }

    .notification-badge {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 18px;
      height: 18px;
      background: var(--red1);
      border-radius: 50%;
      font-size: 11px;
      font-weight: 600;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--blue1);
      animation: badgePulse 2s infinite;
    }

    @keyframes badgePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .header-title {
      color: white;
      font-size: 18px;
      font-weight: 600;
      text-align: center;
    }

    .header-spacer {
      width: 40px;
    }

    .content {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      background: var(--bg);
    }

    .screen {
      display: none;
      flex-direction: column;
      height: 100%;
      animation: fadeIn 0.2s ease;
    }

    .screen.active {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(10px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* Toast Notification */
    .toast-container {
      position: absolute;
      top: 80px;
      left: 16px;
      right: 16px;
      z-index: 1000;
      pointer-events: none;
    }

    .toast {
      background: var(--card);
      border-radius: var(--radius-md);
      box-shadow: 0 8px 32px rgba(16,24,40,0.2);
      padding: 14px 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      transform: translateY(-100px);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
      pointer-events: auto;
      cursor: pointer;
      border-left: 4px solid var(--blue1);
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--blue1), var(--blue2));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .toast-icon svg {
      width: 20px;
      height: 20px;
      fill: white;
    }

    .toast-content {
      flex: 1;
      min-width: 0;
    }

    .toast-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 2px;
    }

    .toast-text {
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Notifications Panel */
    .notifications-panel {
      position: absolute;
      top: 70px;
      left: 16px;
      right: 16px;
      background: var(--card);
      border-radius: var(--radius-md);
      box-shadow: 0 8px 32px rgba(16,24,40,0.2);
      max-height: 400px;
      overflow-y: auto;
      z-index: 200;
      transform: translateY(-20px);
      opacity: 0;
      visibility: hidden;
      transition: transform 0.25s ease, opacity 0.25s ease, visibility 0.25s;
    }

    .notifications-panel.open {
      transform: translateY(0);
      opacity: 1;
      visibility: visible;
    }

    .notifications-header {
      padding: 14px 16px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .notifications-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
    }

    .notifications-clear {
      font-size: 13px;
      color: var(--blue1);
      cursor: pointer;
    }

    .notification-item {
      padding: 14px 16px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.15s;
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notification-item:active {
      background: #f5f7fa;
    }

    .notification-item.unread {
      background: #f0f7ff;
    }

    .notification-item-text {
      font-size: 14px;
      color: var(--text);
      margin-bottom: 4px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .notification-item-meta {
      font-size: 12px;
      color: var(--muted);
    }

    .notifications-empty {
      padding: 32px 16px;
      text-align: center;
      color: var(--muted);
      font-size: 14px;
    }

    /* Feed Screen */
    .radius-selector {
      position: relative;
      margin: 12px 16px 0;
      z-index: 100;
    }

    .radius-panel {
      background: var(--card);
      padding: 14px 16px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow2);
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: transform 0.1s, border-radius 0.2s;
      position: relative;
      z-index: 2;
    }

    .radius-panel:active {
      transform: scale(0.98);
    }

    .radius-panel.open {
      border-radius: var(--radius-md) var(--radius-md) 0 0;
    }

    .radius-panel svg {
      width: 20px;
      height: 20px;
      fill: var(--blue1);
      margin-right: 10px;
      flex-shrink: 0;
    }

    .radius-panel-text {
      flex: 1;
      font-size: 15px;
      color: var(--text);
      font-weight: 500;
    }

    .radius-panel .chevron {
      width: 20px;
      height: 20px;
      fill: var(--muted);
      transition: transform 0.25s ease;
    }

    .radius-panel.open .chevron {
      transform: rotate(180deg);
    }

    .radius-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card);
      border-radius: 0 0 var(--radius-md) var(--radius-md);
      box-shadow: var(--shadow2);
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transition: max-height 0.3s ease, opacity 0.2s ease;
      z-index: 1;
    }

    .radius-dropdown.open {
      max-height: 400px;
      opacity: 1;
    }

    .radius-option {
      padding: 14px 16px;
      font-size: 15px;
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background 0.15s;
      border-top: 1px solid #f0f0f0;
    }

    .radius-option:active {
      background: #f5f7fa;
    }

    .radius-option.active {
      color: var(--blue1);
      font-weight: 600;
      background: #f0f7ff;
    }

    .radius-option .check {
      width: 20px;
      height: 20px;
      fill: var(--blue1);
      opacity: 0;
    }

    .radius-option.active .check {
      opacity: 1;
    }

    .radius-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.2);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
      z-index: 99;
    }

    .radius-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    /* Tabs */
    .tabs-container {
      display: flex;
      gap: 8px;
      padding: 12px 16px 0;
    }

    .tab-btn {
      flex: 1;
      padding: 10px 8px;
      border: none;
      background: var(--card);
      border-radius: var(--radius-sm);
      font-size: 13px;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .tab-btn svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    .tab-btn.active {
      background: var(--blue1);
      color: white;
    }

    .tab-btn:active {
      transform: scale(0.97);
    }

    .feed-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px 100px;
      -webkit-overflow-scrolling: touch;
    }

    .thought-card {
      background: var(--card);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow2);
      padding: 16px;
      margin-bottom: 12px;
      transition: transform 0.15s, box-shadow 0.15s;
      position: relative;
    }

    .thought-card:active {
      transform: scale(0.98);
    }

    .thought-card.expanded {
      box-shadow: 0 4px 16px rgba(16,24,40,0.15);
    }

    .thought-card.new-thought {
      animation: newThoughtPulse 0.5s ease;
    }

    @keyframes newThoughtPulse {
      0% { transform: scale(0.95); opacity: 0; }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); opacity: 1; }
    }

    .thought-text {
      font-size: 15px;
      line-height: 1.6;
      color: var(--text);
      margin-bottom: 12px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      cursor: pointer;
    }

    .thought-text.collapsed {
      display: -webkit-box;
      -webkit-line-clamp: 6;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .thought-expand-hint {
      color: var(--blue1);
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .thought-expand-hint svg {
      width: 16px;
      height: 16px;
      fill: var(--blue1);
      transition: transform 0.2s;
    }

    .thought-card.expanded .thought-expand-hint svg {
      transform: rotate(180deg);
    }

    .thought-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .thought-meta {
      display: flex;
      align-items: center;
      font-size: 13px;
      color: var(--muted);
    }

    .thought-meta svg {
      width: 14px;
      height: 14px;
      fill: var(--muted);
      margin-right: 6px;
    }

    .thought-actions {
      display: flex;
      gap: 8px;
    }

    .thought-action-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: #f5f7fa;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .thought-action-btn svg {
      width: 18px;
      height: 18px;
      fill: var(--muted);
      transition: fill 0.15s;
    }

    .thought-action-btn:active {
      transform: scale(0.9);
    }

    .thought-action-btn.saved {
      background: #fef3c7;
    }

    .thought-action-btn.saved svg {
      fill: var(--orange1);
    }

    .empty-state {
      background: var(--card);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow2);
      padding: 32px 20px;
      text-align: center;
      color: var(--muted);
      font-size: 15px;
    }

    .bottom-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
      background: linear-gradient(to top, var(--bg) 70%, transparent);
    }

    .btn-primary {
      width: 100%;
      height: 52px;
      background: linear-gradient(135deg, var(--blue1) 0%, var(--blue2) 100%);
      border: none;
      border-radius: var(--radius-sm);
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(42,127,255,0.35);
      transition: transform 0.1s, box-shadow 0.1s;
    }

    .btn-primary:active {
      transform: scale(0.97);
      box-shadow: 0 2px 8px rgba(42,127,255,0.35);
    }

    .btn-primary:disabled {
      background: #c4c9d4;
      box-shadow: none;
      cursor: not-allowed;
    }

    /* Write Screen */
    .write-content {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
    }

    .textarea-container {
      background: var(--card);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow2);
      flex: 1;
      display: flex;
      flex-direction: column;
      max-height: 400px;
    }

    .thought-textarea {
      flex: 1;
      border: none;
      outline: none;
      resize: none;
      padding: 16px;
      font-size: 16px;
      line-height: 1.6;
      color: var(--text);
      font-family: inherit;
      background: transparent;
      border-radius: var(--radius-md);
    }

    .thought-textarea::placeholder {
      color: var(--muted);
    }

    .char-counter {
      padding: 8px 16px 12px;
      text-align: right;
      font-size: 13px;
      color: var(--muted);
    }

    .char-counter.warning {
      color: #f59e0b;
    }

    .char-counter.error {
      color: #ef4444;
    }

    .write-info {
      text-align: center;
      padding: 16px;
      font-size: 14px;
      color: var(--muted);
    }

    .write-info .wait-time {
      color: var(--blue1);
      font-weight: 500;
      margin-top: 4px;
    }

    .write-info .min-chars {
      color: #f59e0b;
      font-size: 13px;
      margin-top: 4px;
    }

    .write-buttons {
      display: flex;
      gap: 12px;
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
    }

    .btn-secondary {
      flex: 1;
      height: 52px;
      background: var(--card);
      border: 1px solid #e5e7eb;
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.1s, background 0.1s;
    }

    .btn-secondary:active {
      transform: scale(0.97);
      background: #f9fafb;
    }

    .write-buttons .btn-primary {
      flex: 1;
    }

    /* Saved Screen */
    .saved-header {
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .saved-header svg {
      width: 20px;
      height: 20px;
      fill: var(--orange1);
    }

    .saved-header span {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
    }

    @media (max-width: 440px) {
      body {
        padding: 0;
      }
      .phone-container {
        max-width: 100%;
        height: 100vh;
        height: 100dvh;
        max-height: none;
        border-radius: 0;
      }
      .header {
        border-radius: 0;
        padding-top: calc(16px + env(safe-area-inset-top, 0px));
      }
    }
  </style>
</head>
<body>
  <div class="phone-container">
    <header class="header" id="header">
      <!-- Dynamic header content -->
    </header>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notifications-panel">
      <div class="notifications-header">
        <span class="notifications-title">Уведомления</span>
        <span class="notifications-clear" id="notifications-clear">Очистить</span>
      </div>
      <div id="notifications-list"></div>
    </div>
    
    <main class="content">
      <!-- Feed Screen -->
      <section class="screen active" id="screen-feed">
        <div class="radius-overlay" id="radius-overlay"></div>
        
        <div class="radius-selector">
          <div class="radius-panel" id="radius-panel">
            <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
            <span class="radius-panel-text" id="radius-text">Радиус: 500 метров</span>
            <svg class="chevron" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
          </div>
          <div class="radius-dropdown" id="radius-dropdown">
            <!-- Dynamic options -->
          </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs-container">
          <button class="tab-btn active" id="tab-all">
            <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
            Все мысли
          </button>
          <button class="tab-btn" id="tab-saved">
            <svg viewBox="0 0 24 24"><path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2z"/></svg>
            Сохранённые
          </button>
        </div>
        
        <div class="feed-list" id="feed-list">
          <!-- Dynamic cards -->
        </div>
        
        <div class="bottom-bar">
          <button class="btn-primary" id="btn-write">Написать мысль</button>
        </div>
      </section>
      
      <!-- Write Screen -->
      <section class="screen" id="screen-write">
        <div class="write-content">
          <div class="textarea-container">
            <textarea class="thought-textarea" id="thought-input" placeholder="Введите вашу мысль..." maxlength="10000"></textarea>
            <div class="char-counter" id="char-counter">0 / 10000 знаков</div>
          </div>
          <div class="write-info" id="write-info">
            Можно написать 1 мысль в час.
          </div>
        </div>
        <div class="write-buttons">
          <button class="btn-secondary" id="btn-cancel">Отмена</button>
          <button class="btn-primary" id="btn-publish" disabled>Опубликовать</button>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ============================================================
    // SOUND SYSTEM (Web Audio API)
    // ============================================================
    const SoundEngine = {
      ctx: null,
      enabled: true,

      init() {
        try {
          this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
          this.enabled = false;
        }
      },

      resume() {
        if (this.ctx && this.ctx.state === 'suspended') {
          this.ctx.resume();
        }
      },

      play(type) {
        if (!this.enabled || !this.ctx) return;
        this.resume();

        switch (type) {
          case 'tap': this.playTap(); break;
          case 'success': this.playSuccess(); break;
          case 'navigate': this.playNavigate(); break;
          case 'back': this.playBack(); break;
          case 'error': this.playError(); break;
          case 'select': this.playSelect(); break;
          case 'type': this.playType(); break;
          case 'open': this.playOpen(); break;
          case 'close': this.playClose(); break;
          case 'expand': this.playExpand(); break;
          case 'collapse': this.playCollapse(); break;
          case 'notification': this.playNotification(); break;
          case 'save': this.playSave(); break;
          case 'unsave': this.playUnsave(); break;
        }
      },

      createOscillator(freq, type = 'sine', duration = 0.1, volume = 0.3) {
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        
        gain.gain.setValueAtTime(volume, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        
        osc.start(this.ctx.currentTime);
        osc.stop(this.ctx.currentTime + duration);
      },

      playTap() {
        this.createOscillator(800, 'sine', 0.05, 0.15);
      },

      playSuccess() {
        [523, 659, 784].forEach((freq, i) => {
          setTimeout(() => this.createOscillator(freq, 'sine', 0.15, 0.2), i * 80);
        });
      },

      playNavigate() {
        this.createOscillator(600, 'sine', 0.08, 0.12);
        setTimeout(() => this.createOscillator(900, 'sine', 0.1, 0.15), 50);
      },

      playBack() {
        this.createOscillator(700, 'sine', 0.08, 0.12);
        setTimeout(() => this.createOscillator(500, 'sine', 0.1, 0.1), 50);
      },

      playError() {
        this.createOscillator(200, 'square', 0.15, 0.1);
      },

      playSelect() {
        this.createOscillator(880, 'sine', 0.06, 0.15);
        setTimeout(() => this.createOscillator(1100, 'sine', 0.08, 0.12), 40);
      },

      playType() {
        const freq = 400 + Math.random() * 200;
        this.createOscillator(freq, 'sine', 0.02, 0.05);
      },

      playOpen() {
        this.createOscillator(400, 'sine', 0.08, 0.12);
        setTimeout(() => this.createOscillator(600, 'sine', 0.1, 0.15), 60);
        setTimeout(() => this.createOscillator(800, 'sine', 0.08, 0.1), 120);
      },

      playClose() {
        this.createOscillator(800, 'sine', 0.06, 0.1);
        setTimeout(() => this.createOscillator(600, 'sine', 0.08, 0.12), 50);
        setTimeout(() => this.createOscillator(400, 'sine', 0.1, 0.1), 100);
      },

      playExpand() {
        this.createOscillator(500, 'sine', 0.06, 0.1);
        setTimeout(() => this.createOscillator(700, 'sine', 0.08, 0.12), 50);
      },

      playCollapse() {
        this.createOscillator(700, 'sine', 0.06, 0.1);
        setTimeout(() => this.createOscillator(500, 'sine', 0.08, 0.1), 50);
      },

      playNotification() {
        [784, 988, 1175].forEach((freq, i) => {
          setTimeout(() => this.createOscillator(freq, 'sine', 0.12, 0.18), i * 100);
        });
      },

      playSave() {
        this.createOscillator(523, 'sine', 0.1, 0.15);
        setTimeout(() => this.createOscillator(784, 'sine', 0.15, 0.2), 80);
      },

      playUnsave() {
        this.createOscillator(784, 'sine', 0.08, 0.12);
        setTimeout(() => this.createOscillator(523, 'sine', 0.1, 0.1), 60);
      }
    };

    // ============================================================
    // CONSTANTS
    // ============================================================
    const STORAGE_KEYS = {
      thoughts: 'mv_thoughts_v1',
      radius: 'mv_radius_v1',
      lastPost: 'mv_last_post_at_v1',
      expanded: 'mv_expanded_v1',
      saved: 'mv_saved_v1',
      notifications: 'mv_notifications_v1',
      notifRead: 'mv_notif_read_v1'
    };

    const RADIUSES = [
      { value: 100, label: '100 м', labelFull: '100 метров' },
      { value: 500, label: '500 м', labelFull: '500 метров' },
      { value: 1000, label: '1 км', labelFull: '1 километр' },
      { value: 5000, label: '5 км', labelFull: '5 километров' },
      { value: 10000, label: '10 км', labelFull: '10 километров' },
      { value: 50000, label: '50 км', labelFull: '50 километров' },
      { value: 100000, label: '100 км', labelFull: '100 километров' }
    ];

    const MIN_CHARS = 100;
    const MAX_CHARS = 10000;
    const PREVIEW_CHARS = 300;
    const COOLDOWN_MS = 60 * 60 * 1000; // 1 hour

    const RANDOM_THOUGHTS = [
      'Сегодня понял, что счастье - это не цель, а побочный эффект правильной жизни. Когда делаешь то, что нужно, оно приходит само.',
      'Почему мы так боимся одиночества? Может потому, что боимся встретиться с собой настоящим, без масок и ролей.',
      'Город такой шумный, а внутри - тишина. Странное ощущение, когда тысячи людей вокруг, но ты наедине со своими мыслями.',
      'Каждый день мы делаем выбор, даже когда думаем, что не делаем. Бездействие - тоже выбор.',
      'Интересно, сколько людей прямо сейчас думают о том же, о чём думаю я? Мы все связаны невидимыми нитями.',
      'Закат сегодня особенно красивый. Почему мы так редко останавливаемся, чтобы просто посмотреть на небо?',
      'Время - единственный ресурс, который невозможно вернуть. Потратьте его на то, что действительно важно.',
      'Иногда лучшее решение - просто подождать. Не всё нужно решать прямо сейчас.',
      'Удивительно, как музыка может изменить настроение за секунды. Что ещё обладает такой силой?',
      'Мы все актёры в театре жизни. Но кто написал сценарий?'
    ];

    const ICONS = {
      cloud: `<svg viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM19 18H6c-2.21 0-4-1.79-4-4s1.79-4 4-4h.71C7.37 7.69 9.48 6 12 6c3.04 0 5.5 2.46 5.5 5.5v.5H19c1.66 0 3 1.34 3 3s-1.34 3-3 3z"/></svg>`,
      bell: `<svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>`,
      back: `<svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>`,
      pin: `<svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`,
      check: `<svg class="check" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>`,
      chevronDown: `<svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>`,
      bookmark: `<svg viewBox="0 0 24 24"><path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2z"/></svg>`,
      bookmarkOutline: `<svg viewBox="0 0 24 24"><path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2zm0 15l-5-2.18L7 18V5h10v13z"/></svg>`,
      thought: `<svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>`
    };

    // ============================================================
    // STATE
    // ============================================================
    let state = {
      currentScreen: 'feed',
      currentTab: 'all',
      radius: 500,
      thoughts: [],
      lastPostAt: null,
      dropdownOpen: false,
      expandedCards: new Set(),
      savedThoughts: new Set(),
      notifications: [],
      unreadCount: 0,
      notificationsOpen: false
    };

    // ============================================================
    // STORAGE FUNCTIONS
    // ============================================================
    function loadState() {
      try {
        const thoughts = localStorage.getItem(STORAGE_KEYS.thoughts);
        const radius = localStorage.getItem(STORAGE_KEYS.radius);
        const lastPost = localStorage.getItem(STORAGE_KEYS.lastPost);
        const expanded = localStorage.getItem(STORAGE_KEYS.expanded);
        const saved = localStorage.getItem(STORAGE_KEYS.saved);
        const notifications = localStorage.getItem(STORAGE_KEYS.notifications);
        const notifRead = localStorage.getItem(STORAGE_KEYS.notifRead);

        state.thoughts = thoughts ? JSON.parse(thoughts) : [];
        state.radius = radius ? parseInt(radius, 10) : 500;
        state.lastPostAt = lastPost ? parseInt(lastPost, 10) : null;
        state.expandedCards = expanded ? new Set(JSON.parse(expanded)) : new Set();
        state.savedThoughts = saved ? new Set(JSON.parse(saved)) : new Set();
        state.notifications = notifications ? JSON.parse(notifications) : [];
        
        const readCount = notifRead ? parseInt(notifRead, 10) : 0;
        state.unreadCount = Math.max(0, state.notifications.length - readCount);
      } catch (e) {
        console.warn('Failed to load state:', e);
      }
    }

    function saveThoughts() {
      localStorage.setItem(STORAGE_KEYS.thoughts, JSON.stringify(state.thoughts));
    }

    function saveRadius() {
      localStorage.setItem(STORAGE_KEYS.radius, state.radius.toString());
    }

    function saveLastPost() {
      if (state.lastPostAt) {
        localStorage.setItem(STORAGE_KEYS.lastPost, state.lastPostAt.toString());
      }
    }

    function saveExpanded() {
      localStorage.setItem(STORAGE_KEYS.expanded, JSON.stringify([...state.expandedCards]));
    }

    function saveSaved() {
      localStorage.setItem(STORAGE_KEYS.saved, JSON.stringify([...state.savedThoughts]));
    }

    function saveNotifications() {
      localStorage.setItem(STORAGE_KEYS.notifications, JSON.stringify(state.notifications));
    }

    function markNotificationsRead() {
      localStorage.setItem(STORAGE_KEYS.notifRead, state.notifications.length.toString());
      state.unreadCount = 0;
    }

    // ============================================================
    // SEED DATA
    // ============================================================
    function seedIfEmpty() {
      if (state.thoughts.length > 0) return;

      const now = Date.now();
      state.thoughts = [
        {
          id: generateId(),
          text: 'Иногда так хочется просто исчезнуть на время, чтобы никто не искал. Уехать куда-нибудь далеко, где тебя никто не знает, и просто побыть наедине с собой. Не отвечать на звонки, не проверять сообщения. Просто быть. Смотреть на закат, слушать тишину, думать о чем-то своем. Может это и есть настоящий отдых - не от работы, а от ожиданий окружающих.',
          created_at: now - 5 * 60 * 1000,
          distance_m: 200
        },
        {
          id: generateId(),
          text: 'Почему разговоры с незнакомцами в транспорте бывают такими искренними! Сегодня ехала в автобусе и разговорилась с пожилой женщиной. За 20 минут она рассказала мне больше мудрых вещей, чем я слышала за последний год. Может потому что мы знаем, что больше никогда не встретимся, и можем быть настоящими.',
          created_at: now - 15 * 60 * 1000,
          distance_m: 450
        },
        {
          id: generateId(),
          text: 'Кажется, я стою на перепутье, и не знаю, куда двигаться дальше...',
          created_at: now - 30 * 60 * 1000,
          distance_m: 600
        }
      ];
      saveThoughts();
    }

    // ============================================================
    // UTILS
    // ============================================================
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
    }

    function pluralize(n, forms) {
      const n10 = n % 10;
      const n100 = n % 100;
      if (n10 === 1 && n100 !== 11) return forms[0];
      if (n10 >= 2 && n10 <= 4 && (n100 < 10 || n100 >= 20)) return forms[1];
      return forms[2];
    }

    function timeAgoRu(ms) {
      const now = Date.now();
      const diff = now - ms;
      const seconds = Math.floor(diff / 1000);
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (seconds < 45) return 'только что';
      if (minutes < 60) {
        return `${minutes} ${pluralize(minutes, ['минуту', 'минуты', 'минут'])} назад`;
      }
      if (hours < 24) {
        return `${hours} ${pluralize(hours, ['час', 'часа', 'часов'])} назад`;
      }
      if (days < 7) {
        return `${days} ${pluralize(days, ['день', 'дня', 'дней'])} назад`;
      }

      const date = new Date(ms);
      const dd = String(date.getDate()).padStart(2, '0');
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const yyyy = date.getFullYear();
      return `${dd}.${mm}.${yyyy}`;
    }

    function formatDistanceRu(m) {
      if (m < 1000) return `${Math.round(m)} м`;
      const km = m / 1000;
      if (km < 10) return `${km.toFixed(1).replace('.', ',')} км`;
      return `${Math.round(km)} км`;
    }

    function formatRadiusText(m) {
      const r = RADIUSES.find(r => r.value === m);
      return r ? r.labelFull : `${m} метров`;
    }

    function getTimeUntilNextPost() {
      if (!state.lastPostAt) return null;
      const elapsed = Date.now() - state.lastPostAt;
      const remaining = COOLDOWN_MS - elapsed;
      if (remaining <= 0) return null;

      const hours = Math.floor(remaining / 3600000);
      const minutes = Math.floor((remaining % 3600000) / 60000);
      return { hours, minutes };
    }

    function generateRandomDistance() {
      const rand = Math.random();
      if (rand < 0.5) return Math.floor(Math.random() * 500) + 50;
      if (rand < 0.8) return Math.floor(Math.random() * 2000) + 500;
      if (rand < 0.95) return Math.floor(Math.random() * 5000) + 2500;
      return Math.floor(Math.random() * 115000) + 5000;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ============================================================
    // TOAST NOTIFICATIONS
    // ============================================================
    function showToast(title, text, onClick) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `
        <div class="toast-icon">${ICONS.thought}</div>
        <div class="toast-content">
          <div class="toast-title">${escapeHtml(title)}</div>
          <div class="toast-text">${escapeHtml(text)}</div>
        </div>
      `;
      
      if (onClick) {
        toast.addEventListener('click', () => {
          onClick();
          hideToast(toast);
        });
      }
      
      container.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 50);
      
      setTimeout(() => hideToast(toast), 5000);
    }

    function hideToast(toast) {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }

    // ============================================================
    // NOTIFICATION SYSTEM
    // ============================================================
    function addNotification(thought) {
      const notification = {
        id: generateId(),
        thoughtId: thought.id,
        text: thought.text,
        distance_m: thought.distance_m,
        created_at: Date.now()
      };
      
      state.notifications.unshift(notification);
      state.unreadCount++;
      saveNotifications();
      
      SoundEngine.play('notification');
      showToast('Новая мысль рядом', thought.text.substring(0, 50) + '...', () => {
        if (state.currentScreen !== 'feed') {
          navigateTo('feed', null);
        }
        state.currentTab = 'all';
        renderTabs();
        renderFeed();
      });
      
      renderNotificationBadge();
    }

    function toggleNotifications() {
      if (state.notificationsOpen) {
        closeNotifications();
      } else {
        openNotifications();
      }
    }

    function openNotifications() {
      state.notificationsOpen = true;
      SoundEngine.play('open');
      document.getElementById('notifications-panel').classList.add('open');
      renderNotificationsList();
      markNotificationsRead();
      renderNotificationBadge();
    }

    function closeNotifications() {
      state.notificationsOpen = false;
      SoundEngine.play('close');
      document.getElementById('notifications-panel').classList.remove('open');
    }

    function clearNotifications() {
      SoundEngine.play('tap');
      state.notifications = [];
      state.unreadCount = 0;
      saveNotifications();
      markNotificationsRead();
      renderNotificationsList();
      renderNotificationBadge();
    }

    function renderNotificationBadge() {
      // Badge is rendered dynamically in header
      renderHeader();
    }

    function renderNotificationsList() {
      const container = document.getElementById('notifications-list');
      
      if (state.notifications.length === 0) {
        container.innerHTML = '<div class="notifications-empty">Нет уведомлений</div>';
        return;
      }
      
      container.innerHTML = state.notifications.slice(0, 20).map(n => `
        <div class="notification-item" data-thought-id="${n.thoughtId}">
          <div class="notification-item-text">${escapeHtml(n.text)}</div>
          <div class="notification-item-meta">${formatDistanceRu(n.distance_m)} - ${timeAgoRu(n.created_at)}</div>
        </div>
      `).join('');
      
      container.querySelectorAll('.notification-item').forEach(item => {
        item.addEventListener('click', () => {
          SoundEngine.play('tap');
          closeNotifications();
          state.currentTab = 'all';
          renderTabs();
          renderFeed();
        });
      });
    }

    // ============================================================
    // SIMULATE NEW THOUGHTS
    // ============================================================
    function simulateNewThought() {
      const text = RANDOM_THOUGHTS[Math.floor(Math.random() * RANDOM_THOUGHTS.length)];
      const distance = generateRandomDistance();
      
      // Only notify if within current radius
      if (distance <= state.radius) {
        const thought = {
          id: generateId(),
          text: text,
          created_at: Date.now(),
          distance_m: distance
        };
        
        state.thoughts.unshift(thought);
        saveThoughts();
        
        addNotification(thought);
        
        if (state.currentScreen === 'feed' && state.currentTab === 'all') {
          renderFeed();
        }
      }
    }

    function startSimulation() {
      // Simulate new thought every 30-90 seconds
      function scheduleNext() {
        const delay = 30000 + Math.random() * 60000;
        setTimeout(() => {
          simulateNewThought();
          scheduleNext();
        }, delay);
      }
      scheduleNext();
    }

    // ============================================================
    // DROPDOWN FUNCTIONS
    // ============================================================
    function toggleDropdown() {
      if (state.dropdownOpen) {
        closeDropdown();
      } else {
        openDropdown();
      }
    }

    function openDropdown() {
      state.dropdownOpen = true;
      SoundEngine.play('open');
      
      const panel = document.getElementById('radius-panel');
      const dropdown = document.getElementById('radius-dropdown');
      const overlay = document.getElementById('radius-overlay');
      
      panel.classList.add('open');
      dropdown.classList.add('open');
      overlay.classList.add('open');
    }

    function closeDropdown() {
      state.dropdownOpen = false;
      SoundEngine.play('close');
      
      const panel = document.getElementById('radius-panel');
      const dropdown = document.getElementById('radius-dropdown');
      const overlay = document.getElementById('radius-overlay');
      
      panel.classList.remove('open');
      dropdown.classList.remove('open');
      overlay.classList.remove('open');
    }

    function selectRadius(value) {
      state.radius = value;
      saveRadius();
      SoundEngine.play('select');
      
      renderRadiusPanel();
      renderRadiusDropdown();
      renderFeed();
      
      setTimeout(() => closeDropdown(), 150);
    }

    // ============================================================
    // CARD EXPAND/COLLAPSE
    // ============================================================
    function toggleCard(id) {
      if (state.expandedCards.has(id)) {
        state.expandedCards.delete(id);
        SoundEngine.play('collapse');
      } else {
        state.expandedCards.add(id);
        SoundEngine.play('expand');
      }
      saveExpanded();
      renderFeed();
    }

    // ============================================================
    // SAVE/UNSAVE THOUGHTS
    // ============================================================
    function toggleSave(id, event) {
      event.stopPropagation();
      
      if (state.savedThoughts.has(id)) {
        state.savedThoughts.delete(id);
        SoundEngine.play('unsave');
      } else {
        state.savedThoughts.add(id);
        SoundEngine.play('save');
      }
      saveSaved();
      renderFeed();
    }

    // ============================================================
    // TABS
    // ============================================================
    function switchTab(tab) {
      if (state.currentTab === tab) return;
      
      state.currentTab = tab;
      SoundEngine.play('select');
      renderTabs();
      renderFeed();
    }

    function renderTabs() {
      document.getElementById('tab-all').className = `tab-btn ${state.currentTab === 'all' ? 'active' : ''}`;
      document.getElementById('tab-saved').className = `tab-btn ${state.currentTab === 'saved' ? 'active' : ''}`;
    }

    // ============================================================
    // RENDER FUNCTIONS
    // ============================================================
    function renderHeader() {
      const header = document.getElementById('header');
      
      if (state.currentScreen === 'feed') {
        const badge = state.unreadCount > 0 
          ? `<span class="notification-badge">${state.unreadCount > 9 ? '9+' : state.unreadCount}</span>` 
          : '';
        
        header.innerHTML = `
          <div class="header-content">
            <div class="header-icon">${ICONS.cloud}</div>
            <h1 class="header-title">Мысли вокруг</h1>
            <div class="header-icon" id="btn-notifications">
              ${ICONS.bell}
              ${badge}
            </div>
          </div>
        `;
        
        document.getElementById('btn-notifications').addEventListener('click', () => {
          toggleNotifications();
        });
      } else {
        header.innerHTML = `
          <div class="header-content">
            <div class="header-icon" id="btn-back">${ICONS.back}</div>
            <h1 class="header-title">Написать мысль</h1>
            <div class="header-spacer"></div>
          </div>
        `;
        document.getElementById('btn-back').addEventListener('click', () => navigateTo('feed', 'back'));
      }
    }

    function renderRadiusDropdown() {
      const container = document.getElementById('radius-dropdown');
      container.innerHTML = RADIUSES.map(r => `
        <div class="radius-option ${r.value === state.radius ? 'active' : ''}" data-radius="${r.value}">
          <span>${r.labelFull}</span>
          ${ICONS.check}
        </div>
      `).join('');

      container.querySelectorAll('.radius-option').forEach(opt => {
        opt.addEventListener('click', (e) => {
          e.stopPropagation();
          const radius = parseInt(opt.dataset.radius, 10);
          selectRadius(radius);
        });
      });
    }

    function renderRadiusPanel() {
      document.getElementById('radius-text').textContent = `Радиус: ${formatRadiusText(state.radius)}`;
    }

    function renderFeed() {
      const container = document.getElementById('feed-list');
      
      let filtered;
      if (state.currentTab === 'saved') {
        filtered = state.thoughts
          .filter(t => state.savedThoughts.has(t.id))
          .sort((a, b) => b.created_at - a.created_at);
      } else {
        filtered = state.thoughts
          .filter(t => t.distance_m <= state.radius)
          .sort((a, b) => b.created_at - a.created_at);
      }

      if (filtered.length === 0) {
        const emptyText = state.currentTab === 'saved' 
          ? 'Нет сохранённых мыслей.' 
          : 'Пока нет мыслей в этом радиусе.';
        container.innerHTML = `<div class="empty-state">${emptyText}</div>`;
        return;
      }

      container.innerHTML = filtered.map(t => {
        const isExpanded = state.expandedCards.has(t.id);
        const isSaved = state.savedThoughts.has(t.id);
        const needsTruncate = t.text.length > PREVIEW_CHARS;
        const displayText = (!needsTruncate || isExpanded) 
          ? escapeHtml(t.text) 
          : escapeHtml(t.text.substring(0, PREVIEW_CHARS)) + '...';
        
        return `
          <div class="thought-card ${isExpanded ? 'expanded' : ''}" data-id="${t.id}">
            <div class="thought-text ${needsTruncate && !isExpanded ? 'collapsed' : ''}">${displayText}</div>
            ${needsTruncate ? `
              <div class="thought-expand-hint" data-id="${t.id}">
                ${isExpanded ? 'Свернуть' : 'Читать дальше'}
                ${ICONS.chevronDown}
              </div>
            ` : ''}
            <div class="thought-footer">
              <div class="thought-meta">
                ${ICONS.pin}
                <span>${formatDistanceRu(t.distance_m)} - ${timeAgoRu(t.created_at)}</span>
              </div>
              <div class="thought-actions">
                <button class="thought-action-btn ${isSaved ? 'saved' : ''}" data-save-id="${t.id}">
                  ${isSaved ? ICONS.bookmark : ICONS.bookmarkOutline}
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // Bind expand clicks
      container.querySelectorAll('.thought-expand-hint').forEach(hint => {
        hint.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleCard(hint.dataset.id);
        });
      });

      // Bind text clicks for expand
      container.querySelectorAll('.thought-text').forEach(text => {
        text.addEventListener('click', () => {
          const card = text.closest('.thought-card');
          const id = card.dataset.id;
          const thought = state.thoughts.find(t => t.id === id);
          if (thought && thought.text.length > PREVIEW_CHARS) {
            toggleCard(id);
          } else {
            SoundEngine.play('tap');
          }
        });
      });

      // Bind save clicks
      container.querySelectorAll('.thought-action-btn[data-save-id]').forEach(btn => {
        btn.addEventListener('click', (e) => toggleSave(btn.dataset.saveId, e));
      });
    }

    function renderWrite() {
      const input = document.getElementById('thought-input');
      const counter = document.getElementById('char-counter');
      const info = document.getElementById('write-info');
      const btn = document.getElementById('btn-publish');

      const len = input.value.length;
      counter.textContent = `${len} / ${MAX_CHARS} знаков`;
      counter.className = 'char-counter';
      if (len > 0 && len < MIN_CHARS) counter.classList.add('warning');
      if (len >= MAX_CHARS) counter.classList.add('error');

      const wait = getTimeUntilNextPost();
      let infoHtml = 'Можно написать 1 мысль в час.';
      
      if (wait) {
        if (wait.hours > 0) {
          infoHtml += `<div class="wait-time">Можно через ${wait.hours} ч ${wait.minutes} мин</div>`;
        } else {
          infoHtml += `<div class="wait-time">Можно через ${wait.minutes} мин</div>`;
        }
      }
      
      if (len > 0 && len < MIN_CHARS) {
        infoHtml += `<div class="min-chars">Минимум ${MIN_CHARS} знаков.</div>`;
      }

      info.innerHTML = infoHtml;

      const canPublish = len >= MIN_CHARS && len <= MAX_CHARS && !wait;
      btn.disabled = !canPublish;
    }

    // ============================================================
    // NAVIGATION
    // ============================================================
    function navigateTo(screen, soundType = 'navigate') {
      if (soundType) {
        SoundEngine.play(soundType);
      }
      
      // Close dropdowns
      if (state.dropdownOpen) {
        state.dropdownOpen = false;
        document.getElementById('radius-panel').classList.remove('open');
        document.getElementById('radius-dropdown').classList.remove('open');
        document.getElementById('radius-overlay').classList.remove('open');
      }
      
      if (state.notificationsOpen) {
        state.notificationsOpen = false;
        document.getElementById('notifications-panel').classList.remove('open');
      }
      
      state.currentScreen = screen;
      
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(`screen-${screen}`).classList.add('active');
      
      renderHeader();

      if (screen === 'feed') {
        renderFeed();
      } else if (screen === 'write') {
        document.getElementById('thought-input').value = '';
        renderWrite();
        setTimeout(() => document.getElementById('thought-input').focus(), 100);
      }
    }

    // ============================================================
    // EVENT BINDINGS
    // ============================================================
    function bindEvents() {
      document.getElementById('btn-write').addEventListener('click', () => navigateTo('write', 'navigate'));
      document.getElementById('btn-cancel').addEventListener('click', () => navigateTo('feed', 'back'));
      
      document.getElementById('thought-input').addEventListener('input', () => {
        SoundEngine.play('type');
        renderWrite();
      });
      
      document.getElementById('btn-publish').addEventListener('click', publish);

      document.getElementById('radius-panel').addEventListener('click', (e) => {
        e.stopPropagation();
        toggleDropdown();
      });

      document.getElementById('radius-overlay').addEventListener('click', () => {
        if (state.dropdownOpen) closeDropdown();
      });

      document.getElementById('notifications-clear').addEventListener('click', clearNotifications);

      // Tabs
      document.getElementById('tab-all').addEventListener('click', () => switchTab('all'));
      document.getElementById('tab-saved').addEventListener('click', () => switchTab('saved'));

      // Close notifications when clicking outside
      document.addEventListener('click', (e) => {
        if (state.notificationsOpen) {
          const panel = document.getElementById('notifications-panel');
          const btn = document.getElementById('btn-notifications');
          if (!panel.contains(e.target) && !btn.contains(e.target)) {
            closeNotifications();
          }
        }
      });
    }

    // ============================================================
    // PUBLISH
    // ============================================================
    function publish() {
      const input = document.getElementById('thought-input');
      const text = input.value.trim();

      if (text.length < MIN_CHARS || text.length > MAX_CHARS) {
        SoundEngine.play('error');
        return;
      }
      if (getTimeUntilNextPost()) {
        SoundEngine.play('error');
        return;
      }

      const thought = {
        id: generateId(),
        text: text,
        created_at: Date.now(),
        distance_m: 0
      };

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          () => {
            thought.distance_m = generateRandomDistance();
            finishPublish(thought);
          },
          () => {
            thought.distance_m = Math.floor(Math.random() * 120000) + 50;
            finishPublish(thought);
          },
          { timeout: 3000 }
        );
      } else {
        thought.distance_m = Math.floor(Math.random() * 120000) + 50;
        finishPublish(thought);
      }
    }

    function finishPublish(thought) {
      state.thoughts.unshift(thought);
      state.lastPostAt = Date.now();
      saveThoughts();
      saveLastPost();
      SoundEngine.play('success');
      navigateTo('feed', null);
    }

    // ============================================================
    // BACKEND STUBS (TODO)
    // ============================================================
    async function apiFetchThoughts(radius) {
      /* TODO: backend */
      return state.thoughts.filter(t => t.distance_m <= radius);
    }

    async function apiPublishThought(thought) {
      /* TODO: backend */
      return thought;
    }

    // ============================================================
    // PWA SERVICE WORKER
    // ============================================================
    function registerSW() {
      if (!('serviceWorker' in navigator)) return;

      const swCode = `
        const CACHE_NAME = 'mv-cache-v1';
        const urlsToCache = ['./'];

        self.addEventListener('install', event => {
          event.waitUntil(
            caches.open(CACHE_NAME)
              .then(cache => cache.addAll(urlsToCache))
              .then(() => self.skipWaiting())
          );
        });

        self.addEventListener('activate', event => {
          event.waitUntil(self.clients.claim());
        });

        self.addEventListener('fetch', event => {
          event.respondWith(
            caches.match(event.request)
              .then(response => response || fetch(event.request))
              .catch(() => caches.match('./'))
          );
        });
      `;

      try {
        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        navigator.serviceWorker.register(swUrl).catch(() => {});
      } catch (e) {}
    }

    // ============================================================
    // INIT
    // ============================================================
    function init() {
      SoundEngine.init();
      loadState();
      seedIfEmpty();
      renderHeader();
      renderRadiusDropdown();
      renderRadiusPanel();
      renderTabs();
      renderFeed();
      bindEvents();
      registerSW();
      startSimulation();
      
      document.addEventListener('touchstart', () => SoundEngine.resume(), { once: true });
      document.addEventListener('click', () => SoundEngine.resume(), { once: true });

      setInterval(() => {
        if (state.currentScreen === 'feed') renderFeed();
        if (state.currentScreen === 'write') renderWrite();
      }, 60000);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html> 
