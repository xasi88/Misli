<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2A7FFF" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="stylesheet" href="/styles.css" />
  <title>–ú—ã—Å–ª–∏ –≤–æ–∫—Ä—É–≥</title>
</head>
<body>
  <header class="header">
    <h1>–ú—ã—Å–ª–∏ –≤–æ–∫—Ä—É–≥</h1>
  </header>

  <main class="container" id="app">
    <section class="thought-card">
      <form id="thoughtForm">
        <label for="thoughtInput" class="sr-only">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –º—ã—Å–ª—å</label>
        <textarea id="thoughtInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –º—ã—Å–ª—å..." required></textarea>
        <div style="margin-top:0.75rem;">
          <button type="submit">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –º—ã—Å–ª—å</button>
          <button type="button" id="clearBtn" style="margin-left:0.5rem; background:#ccc; color:#000;">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
        </div>
      </form>
    </section>

    <section id="thoughtList">
      <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –º—ã—Å–ª–∏ -->
    </section>
  </main>

  <footer style="text-align:center; padding:1rem; color:#666;">
    &copy; –ú—ã—Å–ª–∏ –≤–æ–∫—Ä—É–≥
  </footer>

  <script>
    // Service Worker —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then(reg => {
          console.log('Service Worker registered with scope:', reg.scope);
        }).catch(err => {
          console.warn('Service Worker registration failed:', err);
        });
      });
    }

    // –†–∞–±–æ—Ç–∞ —Å –º—ã—Å–ª—è–º–∏ (localStorage)
    (function () {
      const STORAGE_KEY = 'mysli_thoughts_v1';
      const form = document.getElementById('thoughtForm');
      const input = document.getElementById('thoughtInput');
      const list = document.getElementById('thoughtList');
      const clearBtn = document.getElementById('clearBtn');

      function loadThoughts() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è localStorage', e);
          return [];
        }
      }

      function saveThoughts(items) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ localStorage', e);
        }
      }

      function render() {
        const items = loadThoughts().slice().reverse(); // newest first
        list.innerHTML = '';
        if (items.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'thought-card';
          empty.innerHTML = '<p>–ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤–∞—à–∞ –ª–µ–Ω—Ç–∞ –º—ã—Å–ª–µ–π –ø–æ —Ä–∞–¥–∏—É—Å—É.</p>';
          list.appendChild(empty);
          return;
        }

        items.forEach(item => {
          const card = document.createElement('div');
          card.className = 'thought-card';
          const date = new Date(item.createdAt);
          const coords = (item.lat && item.lng) ? `<div class="meta">üìç ${item.lat.toFixed(4)}, ${item.lng.toFixed(4)}</div>` : '<div class="meta">üìç –Ω–µ —É–∫–∞–∑–∞–Ω–æ</div>';
          card.innerHTML = `
            <div class="text">${escapeHtml(item.text)}</div>
            <div class="meta">üïí ${date.toLocaleString()} ${coords}</div>
          `;
          list.appendChild(card);
        });
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;

        // –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é (–Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é)
        if ('geolocation' in navigator) {
          navigator.geolocation.getCurrentPosition(pos => {
            storeThought(text, pos.coords.latitude, pos.coords.longitude);
          }, err => {
            console.warn('–ì–µ–æ–ø–æ–∑–∏—Ü–∏—è –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞:', err.message);
            storeThought(text, null, null);
          }, { maximumAge: 60_000, timeout: 5000 });
        } else {
          storeThought(text, null, null);
        }

        input.value = '';
      });

      clearBtn.addEventListener('click', () => {
        if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –º—ã—Å–ª–∏?')) return;
        saveThoughts([]);
        render();
      });

      function storeThought(text, lat = null, lng = null) {
        const items = loadThoughts();
        items.push({
          id: Date.now(),
          text,
          createdAt: Date.now(),
          lat,
          lng
        });
        saveThoughts(items);
        render();
      }

      // initial render
      render();

      // expose for debugging
      window.__mysli = { loadThoughts, saveThoughts, render };
    })();
  </script>
</body>
</html>
